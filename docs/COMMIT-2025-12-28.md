# Changes for Commit - 2025-12-28

## Summary
Fix content fix workflow: robust content search, broken link parsing, better logging

## Changes

### Content Fix Generator (`src/website_agent/fixer/content_fix_generator.py`)

1. **Dynamic Content Field Discovery** - PHP code now dynamically discovers ALL text fields
   - Searches all field types: `text`, `text_long`, `text_with_summary`, `string`, `string_long`
   - Searches node fields, paragraph fields, block content, and media
   - Handles nested entity references (paragraphs containing paragraphs)
   - No longer relies on hardcoded field name lists

2. **Surgical LLM Prompt** - Rewrote prompt to enforce strict single-change edits
   - Added explicit rules: "SURGICAL PRECISION", "NO REFORMATTING", "ONE CHANGE ONLY"
   - Added verification checklist for LLM to follow
   - Specific instructions for link removal (keep text, remove `<a>` tags only)

3. **Revision Author Attribution** - PHP code now sets revision author to `claude-agent-test` user
   - Looks up user by username: `$user_storage->loadByProperties(["name" => "claude-agent-test"])`
   - Calls `$node->setRevisionUserId($agent_uid)` before save

4. **Revision Timestamp** - PHP code now sets current time on revisions
   - Added `$node->setRevisionCreationTime(time())` before save

5. **Diff URL in Response** - Added `diff_url` field to ContentFixResult
   - Constructs URL: `/node/{nid}/revisions/view/{old_vid}/{new_vid}/visual_inline`
   - Returns both `revision_url` and `diff_url` in response

### API (`src/website_agent/api/app.py`)

6. **Broken Link Parsing** - Added regex to parse `<a href="url">text</a>` format
   - `original_value` = full link HTML
   - `proposed_value` = just the link text (for removal)
   - Enables LLM to surgically remove broken link tags

7. **Grammar Issue Parsing** - Added alternate regex for `Original:` / `Suggested:` format
   - Now handles both spelling (`"word" â†’ "correction"`) and grammar formats

### GitHub Client (`src/website_agent/fixer/github_client.py`)

8. **Original/Suggested as Separate Blocks** - Updated `create_issue_from_quality_issue()`
   - Added `original_value` and `proposed_value` parameters
   - Displays as separate markdown code blocks (not one horizontal string)

9. **Enhanced Logging** - Added detailed logging for code fix debugging
   - Logs clone operations, search queries, and results
   - Added timeout to git clone subprocess

### Code Fix Generator (`src/website_agent/fixer/code_fix_generator.py`)

10. **Enhanced Logging** - Added detailed logging for code fix debugging
    - Logs search config (branch, pantheon_git_url)
    - Logs search queries generated
    - Logs results for each query

### Orchestrator (`src/website_agent/fixer/orchestrator.py`)

11. **PR Body Formatting** - Shows original/suggested in separate code blocks

12. **Diff URL in GitHub Comments** - Content fix success comment now includes diff URL

13. **Pass original/proposed values** - Updated call to `create_issue_from_quality_issue()`

### Documentation (`docs/STATUS.md`)

14. **Setup Requirements** - Added notes about:
    - `claude-agent-test` Drupal user for revision attribution
    - Pantheon git URL requirement for code fixes

## Files Modified
- `src/website_agent/fixer/content_fix_generator.py`
- `src/website_agent/fixer/github_client.py`
- `src/website_agent/fixer/code_fix_generator.py`
- `src/website_agent/fixer/orchestrator.py`
- `src/website_agent/api/app.py`
- `docs/STATUS.md`

## Testing
- All 41 tests pass
- Deterministic changes (author, timestamp, formatting) should work reliably
- Content search is now dynamic - works with any node type/field structure
- LLM-dependent changes (surgical edits) will be improved but not perfect

### Code Fix Flow (`src/website_agent/fixer/orchestrator.py`, `github_client.py`)

15. **Fixed Code Fix Branch Targeting** - Separated search branch from PR base branch
    - Search in Pantheon multidev (`search_branch` from `PANTHEON_ENV`)
    - Create PR targeting GitHub's default branch (`master`), not multidev
    - Fixes 404 error when multidev branch doesn't exist in GitHub

16. **Prioritize Custom Themes** - Search results now prioritize custom over contrib
    - Sort results: `/custom/` first, other second, `/contrib/` last
    - Ensures fixes target the right theme file

## Known Limitations
- LLM may still occasionally make extra changes despite strict prompt
- Requires `claude-agent-test` user to exist in Drupal for proper attribution
- Diff module must be installed in Drupal for diff URLs to work
- Code fixes require SSH access to Pantheon and `terminus` CLI
